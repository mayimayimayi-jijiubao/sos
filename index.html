<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>急救宝注册</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- 本地 JS 引用 -->
<script src="./av-min.js"></script>
<script src="./qrcode.min.js"></script>

<script>
  // 初始化 LeanCloud
  AV.init({
    appId: "Ivzq5oxAhWX2BqNvdFKQbBjl-gzGzoHsz",
    appKey: "ESfT6VmHoUAzyc8Ay0ebZbuC",
    serverURL: "https://ivzq5oxa.lc-cn-n1-shared.com"
  });

  async function submitForm() {
    const phone = document.getElementById('phone').value.trim();
    const name = document.getElementById('name').value.trim();
    const emergencyName = document.getElementById('emergencyName').value.trim();
    const emergencyPhone = document.getElementById('emergencyPhone').value.trim();

    if (!phone || !name || !emergencyName || !emergencyPhone) {
      alert('请填写所有必填项！');
      return;
    }

    try {
      // 检查是否已存在手机号记录
      const query = new AV.Query('UserInfo');
      query.equalTo('phone', phone);
      const existing = await query.first();
      let obj;
      if (existing) obj = existing;
      else {
        const UserInfo = AV.Object.extend('UserInfo');
        obj = new UserInfo();
      }

      // 保存数据
      obj.set('phone', phone);
      obj.set('name', name);
      obj.set('emergencyName', emergencyName);
      obj.set('emergencyPhone', emergencyPhone);
      await obj.save();

      alert('✅ 信息已保存成功！');

      // 生成二维码 —— 修正跳转到 qrcode 页面
      const url = window.location.origin + '/qrcode?phone=' + encodeURIComponent(phone);
      document.getElementById('qrcode').innerHTML = '';
      new QRCode(document.getElementById('qrcode'), {
        text: url,
        width: 200,
        height: 200
      });

      document.getElementById('resultLink').innerHTML =
        `<p>📱 扫描下方二维码，或 <a href="${url}" target="_blank">点击这里查看急救信息</a></p>`;
    } catch (err) {
      console.error(err);
      alert('❌ 保存失败：' + err.message);
    }
  }
</script>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  margin: 30px;
  max-width: 480px;
  background: #f9fafc;
  color: #333;
}
label {
  display: block;
  margin-bottom: 10px;
  font-size: 15px;
}
input {
  width: 100%;
  padding: 8px;
  margin-top: 4px;
  box-sizing: border-box;
  border: 1px solid #ccc;
  border-radius: 6px;
}
button {
  margin-top: 10px;
  padding: 10px 16px;
  font-size: 16px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 6px;
}
button:hover {
  background-color: #0056b3;
}
#qrcode {
  margin-top: 20px;
}
a {
  color: #007bff;
  text-decoration: none;
}
a:hover {
  text-decoration: underline;
}
</style>
</head>

<body>
  <h2>急救宝注册</h2>
  <p>请填写以下信息后生成急救二维码：</p>

  <label>我的名字（必填）：
    <input id="name" placeholder="请输入姓名">
  </label>

  <label>我的手机号（必填）：
    <input id="phone" type="tel" placeholder="请输入手机号">
  </label>

  <label>紧急联系人名字（必填）：
    <input id="emergencyName" placeholder="请输入紧急联系人姓名">
  </label>

  <label>紧急联系人手机号（必填）：
    <input id="emergencyPhone" type="tel" placeholder="请输入紧急联系人手机号">
  </label>

  <button onclick="submitForm()">提交并生成二维码</button>

  <div id="resultLink"></div>
  <div id="qrcode"></div>
</body>
</html>
