<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<title>æ€¥æ•‘å®æ³¨å†Œ</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- æœ¬åœ° JS å¼•ç”¨ -->
<script src="./av-min.js"></script>
<script src="./qrcode.min.js"></script>

<script>
  // åˆå§‹åŒ– LeanCloud
  AV.init({
    appId: "Ivzq5oxAhWX2BqNvdFKQbBjl-gzGzoHsz",
    appKey: "ESfT6VmHoUAzyc8Ay0ebZbuC",
    serverURL: "https://ivzq5oxa.lc-cn-n1-shared.com"
  });

  async function submitForm() {
    const phone = document.getElementById('phone').value.trim();
    const name = document.getElementById('name').value.trim();
    const emergencyName = document.getElementById('emergencyName').value.trim();
    const emergencyPhone = document.getElementById('emergencyPhone').value.trim();

    if (!phone || !name || !emergencyName || !emergencyPhone) {
      alert('è¯·å¡«å†™æ‰€æœ‰å¿…å¡«é¡¹ï¼');
      return;
    }

    try {
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨æ‰‹æœºå·è®°å½•
      const query = new AV.Query('UserInfo');
      query.equalTo('phone', phone);
      const existing = await query.first();
      let obj;
      if (existing) obj = existing;
      else {
        const UserInfo = AV.Object.extend('UserInfo');
        obj = new UserInfo();
      }

      // ä¿å­˜æ•°æ®
      obj.set('phone', phone);
      obj.set('name', name);
      obj.set('emergencyName', emergencyName);
      obj.set('emergencyPhone', emergencyPhone);
      await obj.save();

      alert('âœ… ä¿¡æ¯å·²ä¿å­˜æˆåŠŸï¼');

      // ç”ŸæˆäºŒç»´ç  â€”â€” ä¿®æ­£è·³è½¬åˆ° qrcode é¡µé¢
      const url = window.location.origin + '/qrcode?phone=' + encodeURIComponent(phone);
      document.getElementById('qrcode').innerHTML = '';
      new QRCode(document.getElementById('qrcode'), {
        text: url,
        width: 200,
        height: 200
      });

      document.getElementById('resultLink').innerHTML =
        `<p>ğŸ“± æ‰«æä¸‹æ–¹äºŒç»´ç ï¼Œæˆ– <a href="${url}" target="_blank">ç‚¹å‡»è¿™é‡ŒæŸ¥çœ‹æ€¥æ•‘ä¿¡æ¯</a></p>`;
    } catch (err) {
      console.error(err);
      alert('âŒ ä¿å­˜å¤±è´¥ï¼š' + err.message);
    }
  }
</script>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  margin: 30px;
  max-width: 480px;
  background: #f9fafc;
  color: #333;
}
label {
  display: block;
  margin-bottom: 10px;
  font-size: 15px;
}
input {
  width: 100%;
  padding: 8px;
  margin-top: 4px;
  box-sizing: border-box;
  border: 1px solid #ccc;
  border-radius: 6px;
}
button {
  margin-top: 10px;
  padding: 10px 16px;
  font-size: 16px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 6px;
}
button:hover {
  background-color: #0056b3;
}
#qrcode {
  margin-top: 20px;
}
a {
  color: #007bff;
  text-decoration: none;
}
a:hover {
  text-decoration: underline;
}
</style>
</head>

<body>
  <h2>æ€¥æ•‘å®æ³¨å†Œ</h2>
  <p>è¯·å¡«å†™ä»¥ä¸‹ä¿¡æ¯åç”Ÿæˆæ€¥æ•‘äºŒç»´ç ï¼š</p>

  <label>æˆ‘çš„åå­—ï¼ˆå¿…å¡«ï¼‰ï¼š
    <input id="name" placeholder="è¯·è¾“å…¥å§“å">
  </label>

  <label>æˆ‘çš„æ‰‹æœºå·ï¼ˆå¿…å¡«ï¼‰ï¼š
    <input id="phone" type="tel" placeholder="è¯·è¾“å…¥æ‰‹æœºå·">
  </label>

  <label>ç´§æ€¥è”ç³»äººåå­—ï¼ˆå¿…å¡«ï¼‰ï¼š
    <input id="emergencyName" placeholder="è¯·è¾“å…¥ç´§æ€¥è”ç³»äººå§“å">
  </label>

  <label>ç´§æ€¥è”ç³»äººæ‰‹æœºå·ï¼ˆå¿…å¡«ï¼‰ï¼š
    <input id="emergencyPhone" type="tel" placeholder="è¯·è¾“å…¥ç´§æ€¥è”ç³»äººæ‰‹æœºå·">
  </label>

  <button onclick="submitForm()">æäº¤å¹¶ç”ŸæˆäºŒç»´ç </button>

  <div id="resultLink"></div>
  <div id="qrcode"></div>
</body>
</html>
